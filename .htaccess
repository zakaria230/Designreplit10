# Rewrite rules for DesignKorv cPanel deployment
RewriteEngine On

# Ensure https
RewriteCond %{HTTPS} !=on
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Static files - serve directly
RewriteCond %{REQUEST_URI} .(css|js|jpg|jpeg|png|gif|svg|ico|woff|woff2|ttf|eot|map)$ [NC]
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule .* - [L]

# If the requested resource exists as a file or directory, serve it directly
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# Handle front-end routes - send React/frontend routes to index.html
RewriteCond %{REQUEST_URI} !^/api/ [NC]
RewriteCond %{REQUEST_URI} !^/socket.io/ [NC]
RewriteCond %{REQUEST_URI} !^/ws/ [NC]
RewriteCond %{REQUEST_URI} !^/uploads/ [NC]
RewriteRule ^(.*)$ /index.html [L]

# Passenger configuration for Node.js
<IfModule mod_passenger.c>
    PassengerNodejs /opt/alt/alt-nodejs18/root/usr/bin/node
    PassengerAppType node
    PassengerStartupFile cjs-adapter.cjs
    # Use correct path with no leading slash
    PassengerAppRoot public_html
    PassengerFriendlyErrorPages on
</IfModule>

# PHP Fallback
<IfModule mod_php.c>
    # PHP is not needed, redirect to Node.js
    RedirectMatch 301 ^/$ /index.html
</IfModule>

# Security headers
<IfModule mod_headers.c>
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set X-Content-Type-Options "nosniff"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Content-Security-Policy "upgrade-insecure-requests;"
</IfModule>

# File permissions
<FilesMatch "\.(env|htaccess|htpasswd|ini|log|yml|yaml|config|db)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>